{
  "Name": "windows-upgrade-preparation",
  "DefaultTimeout": "30m",
  "Vars": {
    "instance": {
      "Required": true,
      "Description": "instance uri"
    },
    "project": {
      "Required": true,
      "Description": "project of the instance"
    },
    "zone": {
      "Required": true,
      "Description": "zone of the instance"
    },
    "original_startup_script_url": {
      "Value": "",
      "Description": "original startup script url"
    },
    "install_media": {
      "Required": true,
      "Description": "install media disk name"
    },
    "install_media_image": {
      "Value": "projects/compute-image-tools/global/images/family/windows-install-media",
      "Description": "image to use for the upgrade worker instance"
    },
    "upgrade_script_name": {
      "Required": true,
      "Description": "upgrade script name"
    },
    "machine_image_backup_name": {
      "Required": true,
      "Description": "machine image backup name"
    },
    "os_disk_snapshot_name": {
      "Required": true,
      "Description": "snapshot name for the existing os disk"
    },
    "new_os_disk_name": {
      "Required": true,
      "Description": "new os disk name"
    },
    "old_os_disk": {
      "Required": true,
      "Description": "old (before upgrade) os disk uri"
    },
    "os_disk_type": {
      "Required": true,
      "Description": "os disk type, pd-ssd or pd-standard"
    },
    "os_disk_device_name": {
      "Required": true,
      "Description": "os disk device name for attaching/detaching"
    },
    "os_disk_auto_delete": {
      "Required": true,
      "Description": "os disk device name for attaching/detaching"
    },
    "upgraded_license": {
      "Required": true,
      "Description": "license to append to the upgraded OS disk"
    }
  },
  "Sources": {
    "upgrade_script.ps1": "./${upgrade_script_name}"
  },
  "Steps": {
    "stop-instance": {
      "StopInstances": {
        "Instances": [
          "${instance}"
        ]
      }
    },
    "backup-machine-image": {
      "CreateMachineImages": [
        {
          "Name": "${machine_image_backup_name}",
          "SourceInstance": "${instance}",
          "ExactName": true,
          "NoCleanup": true
        }
      ]
    },
    "backup-os-disk-snapshot": {
      "CreateSnapshots": [
        {
          "Name": "${os_disk_snapshot_name}",
          "SourceDisk": "${old_os_disk}",
          "ExactName": true,
          "NoCleanup": true
        }
      ]
    },
    "create-new-os-disk": {
      "CreateDisks": [
        {
          "Name": "${new_os_disk_name}",
          "Zone": "${zone}",
          "Type": "${os_disk_type}",
          "SourceSnapshot": "${os_disk_snapshot_name}",
          "Licenses": ["${upgraded_license}"],
          "ExactName": true,
          "NoCleanup": true
        }
      ]
    },
    "detach-old-os-disk": {
      "DetachDisks": [
        {
          "Instance": "${instance}",
          "DeviceName": "projects/${project}/zones/${zone}/devices/${os_disk_device_name}"
        }
      ]
    },
    "attach-new-os-disk": {
      "AttachDisks": [
        {
          "Instance": "${instance}",
          "Source": "${new_os_disk_name}",
          "DeviceName": "${os_disk_device_name}",
          "AutoDelete": ${os_disk_auto_delete},
          "Boot": true
        }
      ]
    },
    "create-install-disk": {
      "CreateDisks": [
        {
          "Name": "${install_media}",
          "Zone": "${zone}",
          "Type": "pd-ssd",
          "SourceImage": "${install_media_image}",
          "ExactName": true,
          "NoCleanup": true
        }
      ]
    },
    "attach-install-disk": {
      "AttachDisks": [
        {
          "Instance": "${instance}",
          "Source": "${install_media}",
          "AutoDelete": true
        }
      ]
    },
    "backup-script": {
      "UpdateInstancesMetadata": [
        {
          "Instance": "${instance}",
          "Metadata": {
            "windows-startup-script-url-backup": "${original_startup_script_url}"
          }
        }
      ]
    },
    "set-script": {
      "UpdateInstancesMetadata": [
        {
          "Instance": "${instance}",
          "Metadata": {
            "windows-startup-script-url": "${SOURCESPATH}/upgrade_script.ps1"
          }
        }
      ]
    }
  },
  "Dependencies": {
    "backup-machine-image": ["stop-instance"],
    "backup-os-disk-snapshot": ["backup-machine-image"],
    "create-new-os-disk": ["backup-os-disk-snapshot"],
    "detach-old-os-disk": ["create-new-os-disk"],
    "attach-new-os-disk": ["detach-old-os-disk"],
    "create-install-disk": ["attach-new-os-disk"],
    "attach-install-disk": ["create-install-disk"],
    "backup-script": ["attach-install-disk"],
    "set-script": ["backup-script"]
  }
}
