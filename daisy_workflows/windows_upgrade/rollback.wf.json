{
  "Name": "rollback",
  "DefaultTimeout": "30m",
  "Vars": {
    "instance": {
      "Required": true,
      "Description": "instance uri"
    },
    "project": {
      "Required": true,
      "Description": "project of the instance"
    },
    "zone": {
      "Required": true,
      "Description": "zone of the instance"
    },
    "install_media": {
      "Required": true,
      "Description": "install media disk name"
    },
    "os_disk_device_name": {
      "Required": true,
      "Description": "OS disk device name"
    },
    "os_disk_auto_delete": {
      "Required": true,
      "Description": "os disk device name for attaching/detaching"
    },
    "old_os_disk": {
      "Required": true,
      "Description": "old OS disk uri"
    },
    "new_os_disk_name": {
      "Required": true,
      "Description": "new OS disk name"
    },
    "original_startup_script_url": {
      "Value": "",
      "Description": "original startup script url"
    }
  },
  "Steps": {
    "stop-instance": {
      "StopInstances": {
        "Instances": ["${instance}"]
      }
    },
    "detach-new-os-disk": {
      "DetachDisks": [
        {
          "Instance": "${instance}",
          "DeviceName": "projects/${project}/zones/${zone}/devices/${os_disk_device_name}"
        }
      ]
    },
    "attach-old-os-disk": {
      "AttachDisks": [
        {
          "Instance": "${instance}",
          "Source": "${old_os_disk}",
          "DeviceName": "${os_disk_device_name}",
          "AutoDelete": "${os_disk_auto_delete}",
          "Boot": true
        }
      ]
    },
    "detach-install-media-disk": {
      "DetachDisks": [
        {
          "Instance": "${instance}",
          "DeviceName": "projects/${project}/zones/${zone}/devices/${install_media}"
        }
      ]
    },
    "restore-script": {
      "UpdateInstancesMetadata": [
        {
          "Instance": "${instance}",
          "Metadata": {
            "windows-startup-script-url": "${original_startup_script_url}"
          }
        }
      ]
    },
    "start-instance": {
      "StartInstances": {
        "Instances": ["${instance}"]
      }
    },
    "delete-new-os-disk": {
      "DeleteResources": {
        "Disks": [
          "projects/${project}/zones/${zone}/disks/${new_os_disk_name}"
        ]
      }
    },
    "delete-install-media-disk": {
      "DeleteResources": {
        "Disks": [
          "projects/${project}/zones/${zone}/disks/${install_media}"
        ]
      }
    }
  },
  "Dependencies": {
    "detach-new-os-disk": ["stop-instance"],
    "attach-old-os-disk": ["detach-new-os-disk"],
    "detach-install-media-disk": ["attach-old-os-disk"],
    "restore-script": ["detach-install-media-disk"],
    "start-instance": ["restore-script"],
    "delete-new-os-disk": ["start-instance"],
    "delete-install-media-disk": ["start-instance"]
  }
}
